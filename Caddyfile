{
	auto_https off
}

http://127.0.0.1:8080 {
	encode zstd gzip

	# Preserve real client IP from Cloudflare
	request_header X-Real-IP {http.request.header.CF-Connecting-IP}
	request_header X-Forwarded-For {http.request.header.CF-Connecting-IP}
	request_header X-Forwarded-Proto {scheme}
	request_header Host {host}

	# MinIO console (subdomain)
	@minioConsole host minio.fibeger.com
	handle @minioConsole {
		reverse_proxy minio:9001
	}

	# MinIO S3 API under /minio on apex
	@minioAPI {
		host fibeger.com
		path /minio/*
	}
	handle @minioAPI {
		uri strip_prefix /minio
		reverse_proxy minio:9000
	}

	# Default: Next.js app
	@app host fibeger.com
	handle @app {
		reverse_proxy app:3000
	}
}
